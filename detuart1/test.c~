#include <avr/io.h>
#include <avr/interrupt.h> 
#include <avr/signal.h> 
#include <avr/delay.h>

#define F_CPU 14745600 // DEFINIMI I F_CPU
#define BAUDRATE 9600 // BAUDRATE 9600
#define BAUDREGISTER ((F_CPU/(16*BAUDRATE))-1) // REGJISTRIMI I BAUDRATE 
unsigned char cnt=0; // DEKLARIMI I COUNTERIT CNT

// INICIALIZIMI I PORTIT
void PortInit(void)
{
  DDRD = 0xFF;
  PORTD = 0xFF;
}

void USART_Init()
{
  //VENDOSJA E BAUD RATE
  UBRR0H =  (BAUDREGISTER >>8);
  UBRR0L = (BAUDREGISTER &0xFF);
  
  //6n1 
  UCSR0B = (1<<RXEN0)|(1<<TXEN0); // BEHET ENABLE RECEIVE DHE TRANSMIT
  UCSR0C = (1<<UCSZ0); // PER MESAZH 6 BIT
  UCSR0C = (3<<UPM0); // VLERA 3 PER PARITET TEK; 1 ESHTE RESERVED, 2 PER PARITET QIFT, 3 PER PARITET PER TEK (TAB. 78 FQ. 193) 
  PortInit();  // INICIALIZIMI I PORTEVE
}

// METODE PER PRANIMIN E MESAZHIT
char  USART_Rx()
{
  while(!(UCSR0A &(1<<RXC0)));// PERDERISA KA TE DHENA TE PALEXUARA NE BUFFER SHPREHJA KTHEN VLEREN UDR0 DMTH DEL NGA CIKLI WHILE , NESE ESHTE KRYER LEXIMI RRIN NE WHILE LOOP DUKE PRITUR PER TE DHENA
  return UDR0; // E KTHEN URD0
}

void USART_Transmit(unsigned char data)
{
  while(!(UCSR0A &(1<<UDRE0))); // PERDERISA UDR0 ESHTE 1 D.T.TH QE BUFFERI ESHTE I GATSHEM PER TE SHKRUAR NE TE, DHE REGJISTRI MBISHKRUHET ME MESAZHIN QE E KEMI DERGUAR (DATA) 
  UDR0 = data; // E BARTE MESAZHIN NE UDR0
}


int main(void){
    int i; // DEKLARIMI I VARIABLES I
    USART_Init(); 
     
    while(1)
	{
		cnt = USART_Rx(); // PRANIMI I MESAZHIT
		PORTD = ~(1<<cnt); // BARTJA MESAZHIT NE PORTD
		cnt++; // INKREMENTIMI PER NJE I CNT
		for(i = 0; i<60000; i++); // provo per 10000 per 1sec
		USART_Transmit(cnt); // DERGIM I MESAZHIT		
	}

return 0; // DALJE NGA PROGRAMI
}
